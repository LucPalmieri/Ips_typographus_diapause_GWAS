# Genome-Wide Association and Machine Learning Analysis of Diapause Polymorphism in *Ips typographus*

This repository contains the complete bioinformatic pipeline for identifying genetic polymorphisms associated with obligate and facultative diapause phenotypes in the European spruce bark beetle (*Ips typographus*). The analysis combines genomic approaches (ddRAD sequencing, GWAS, annotation) with machine learning classification to predict diapause phenotypes.

## Publication

This work is part of a manuscript in preparation for submission to *Molecular Ecology*.

## Overview

The pipeline processes ddRAD-seq data from three European populations of *I. typographus* (LOW: Prinzersdorf, Austria; HIGH: Gesäuse, Austria; NORTH: Vindeln, Sweden) to:

1. **Identify SNPs associated with diapause phenotype** via Bayesian genome-wide association
2. **Rank candidate loci** using machine learning (LightGBM with Optuna optimization)
3. **Characterize functional regions** by mapping SNPs to genes and performing GO enrichment
4. **Predict phenotypes** in wild populations to estimate outbreak risk

## Data & Sample Overview

- **Phenotyped samples**: 297 individuals (59-61 obligate, 60-61 facultative per population)
- **Wild samples**: 286 individuals (randomly sampled from natural populations)
- **Sequencing**: Illumina HiSeq2000 (forward reads only after quality filtering)
- **Assembly method**: Reference-based ddRAD with ipyrad v0.9.95
- **Final SNP set**: 11,867 variants after LD pruning
- **Populations**: 3 geographic sites (LOW, HIGH, NORTH)

## Workflow Overview

```
Raw fastq reads
    ↓
Demultiplexing & VCF filtering
    ↓
ipyrad reference-based assembly
    ↓
vcftools filtering (remove >25% missing)
    ↓
PLINK LD pruning
    ↓
┌─────────────────────────────────┬──────────────────────────────────┐
│                                 │                                  │
Population Structure Analysis    GWAS Analysis                    ML Classification
│                                 │                                  │
├─ VCA                            ├─ VCF → BayPass format          ├─ Genotype encoding
├─ STRUCTURE                      ├─ BayPass core model            ├─ Optuna optimization
│                                 ├─ Importance sampling           ├─ LightGBM training
└─ Visualization                  ├─ Pseudo-observations           ├─ Cross-validation
                                  └─ Bayes Factor ranking          └─ Feature ranking
                                                                        
                                  ↓
                        Annotation & Interpretation
                        
                        ├─ Liftoff annotation transfer
                        ├─ SNP → Gene mapping
                        ├─ GO enrichment analysis
                        └─ Functional characterization
                        
                                  ↓
                        Wild Population Classification
                        
                        ├─ Predict phenotypes in wild individuals
                        ├─ Estimate population-level frequencies
                        └─ Assess outbreak risk
```

## Directory Structure

```
Ips_typographus_diapause_GWAS/
├── README.md                    # This file
├── WORKFLOW.md                  # Detailed execution guide
├── DATA_DICTIONARY.md           # Input/output file specifications
├── requirements/                # Software & dependency specifications
│   ├── environment.yml          # Conda environment file
│   ├── requirements.txt          # Python packages
│   └── r_packages.R             # R libraries installation script
├── scripts/                     # Analysis scripts organized by stage
│   ├── 00_demultiplex_filter/   # Raw read processing
│   ├── 01_assembly/             # ipyrad assembly
│   ├── 02_variant_filtering/    # vcftools & PLINK filtering
│   ├── 03_population_genetics/  # VCA & STRUCTURE
│   ├── 04_annotation/           # Liftoff & SNP-to-gene mapping
│   ├── 05_gwas_baypass/         # GWAS analysis with BayPass
│   ├── 06_machine_learning/     # ML pipeline (LightGBM + Optuna)
│   ├── 07_functional_annotation/# GO enrichment analysis
│   ├── 08_visualization/        # Result plots & figures
│   └── utils/                   # Utility functions (statistical tests)
├── data/                        # Input data directory
│   ├── README.md                # Data file specifications
│   └── examples/                # Template/example input files
├── results/                     # Output directory (generated by scripts)
└── docs/                        # Additional documentation
    ├── METHODS_SUMMARY.md       # Brief methods overview
    ├── SOFTWARE_VERSIONS.md     # Complete software version list
    └── TROUBLESHOOTING.md       # Common issues & solutions
```

## Quick Start

### 1. Clone & Setup

```bash
git clone https://github.com/YOUR_USERNAME/Ips_typographus_diapause_GWAS.git
cd Ips_typographus_diapause_GWAS
```

### 2. Install Dependencies

```bash
# Create conda environment
conda env create -f requirements/environment.yml
conda activate ips_typographus

# Install R packages
Rscript requirements/r_packages.R

# Install Python packages
pip install -r requirements/requirements.txt
```

### 3. Execute Pipeline

See `WORKFLOW.md` for step-by-step execution instructions.

```bash
# Typical execution order:
# 1. bash scripts/01_assembly/ipyrad_assembly.sh
# 2. bash scripts/02_variant_filtering/plink_pruning.sh
# 3. Rscript scripts/03_population_genetics/VCA_analysis.R
# ... (see WORKFLOW.md for complete order)
```

## Key Results & Outputs

### Genome-Wide Association
- **SNP annotations**: Moderate/strong Bayes Factor associations (BF > 6)
- **Manhattan plot**: Genome-wide significance landscape
- **Effect sizes**: LightGBM feature importance rankings

### Machine Learning Validation
- **Cross-validation metrics**: AUROC, F1 score, accuracy
- **Mock population accuracy**: Model validation on synthetic populations
- **Feature importance**: Ranked SNP predictive power

### Functional Interpretation
- **Gene annotations**: SNP-to-gene mapping with genomic features
- **GO enrichment**: Significantly over-represented biological processes
- **Candidate genes**: Putative diapause mechanism loci

### Phenotype Predictions
- **Wild population classifications**: Predicted phenotype frequencies
- **Outbreak risk assessment**: Population-level obligate/facultative ratios
- **Geographic patterns**: Diapause trait distribution across populations

## Software Requirements

See `docs/SOFTWARE_VERSIONS.md` for complete version information. Core tools:

- **Bioinformatics**: ipyrad v0.9.95, vcftools v0.1.16, PLINK v1.90b6.21, BayPass v2.41
- **Machine Learning**: Python 3.9+, LightGBM v4.5.0, Optuna v4.2.0, scikit-learn v1.5.2
- **Statistics & Visualization**: R 4.4.2, goseq v1.60.0, adegenet v1.3.1, rrBLUP v4.6.3

## Methods & Citation

For detailed methods, see the manuscript or `docs/METHODS_SUMMARY.md`.

**Citation**: [Will be added upon publication]

## Data Availability

Raw sequence data and phenotype data are available at [REPOSITORY/DATABASE]. Analysis-ready VCF and intermediate files are provided in the `data/` directory.

## Authors

**Luciano Palmieri**

*Code revised with Claude Sonnet 4.5*

## Contact

For questions or issues, please open an issue on the GitHub repository.

## License

This project is licensed under the MIT License - see LICENSE file for details.

---

**Note**: This repository is a snapshot of the analysis performed for publication. For the latest updates and improvements, see the active development branch.
